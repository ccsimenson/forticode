"use strict";const o=require("electron"),n=require("path");require("module-alias/register");require("module-alias").addAliases({"@modules":n.join(__dirname,"..","modules")});const m=require("@modules/csp/CspValidator").default;let c,d,u;const E=()=>{if(process.platform!=="win32")return!1;const e=n.resolve(process.execPath,".."),r=n.resolve(e,".."),s=n.resolve(n.join(r,"Update.exe")),a=n.basename(process.execPath),i=require("child_process").spawn,l=w=>{try{return i(s,w,{detached:!0}).on("close",()=>process.exit()),!0}catch(v){return console.error("Failed to spawn Squirrel process:",v),!1}},p=process.argv[1];switch(console.log("Processing Squirrel event:",p),p){case"--squirrel-install":case"--squirrel-updated":return l(["--createShortcut",a]),!0;case"--squirrel-uninstall":return l(["--removeShortcut",a]),!0;case"--squirrel-obsolete":return o.app.quit(),!0}return!1};E()&&(console.log("Handled Squirrel event, exiting..."),setTimeout(o.app.quit,100),process.exit(0));const _=o.app.requestSingleInstanceLock();_||(o.app.quit(),process.exit(0));const f=process.env.NODE_ENV==="development"||process.env.ELECTRON_IS_DEV==="1";let t=null;o.app.on("ready",()=>{global.__mainWindow=t});console.log("Initializing CSP Validator...");let h;try{h=m.getInstance(),console.log("CSP Validator initialized successfully")}catch(e){console.error("Failed to initialize CSP Validator:",e),process.exit(1)}function q(){h.registerIpcHandlers(o.ipcMain),o.ipcMain.handle("app:getVersion",()=>o.app.getVersion())}const g=async()=>{if(t){t.isMinimized()&&t.restore(),t.focus();return}if(t=new o.BrowserWindow({show:!1,width:1200,height:800,webPreferences:{nodeIntegration:!1,contextIsolation:!0,preload:n.join(__dirname,"preload.js"),webSecurity:!0,allowRunningInsecureContent:!1,webgl:!1,plugins:!1},title:"Electron Security Auditor",icon:n.join(__dirname,"../../assets/icon.png")}),f)try{const e="http://localhost:3001";console.log(`Connecting to Vite dev server at ${e}`);const r=10;let s=0,a=!1;for(;s<r&&!a;)try{console.log(`Attempting to connect to Vite dev server (attempt ${s+1}/${r})...`),await t.loadURL(e),a=!0,console.log("Successfully connected to Vite dev server")}catch(i){if(s++,s>=r)throw console.error("Failed to connect to Vite dev server after multiple attempts:",i),i;await new Promise(l=>setTimeout(l,1e3))}if(t.webContents.openDevTools({mode:"detach"}),!c){const i=await Promise.resolve().then(()=>require("./index-2c0fc821.js")).then(l=>l.index);c=i.default,d=i.REACT_DEVELOPER_TOOLS,u=i.REDUX_DEVTOOLS,console.log("Installing developer tools...");try{await Promise.all([c(d),c(u)]),console.log("Developer tools installed successfully")}catch(l){console.error("Failed to install devtools:",l)}}console.log("Development server started successfully")}catch(e){console.error("Failed to start development server:",e),t&&t.loadFile(n.join(__dirname,"../../public/error.html"))}else MAIN_WINDOW_VITE_DEV_SERVER_URL?await t.loadURL(MAIN_WINDOW_VITE_DEV_SERVER_URL):await t.loadFile(n.join(__dirname,"../../dist/renderer/index.html"));t.webContents.setWindowOpenHandler(({url:e})=>(e.startsWith("http")&&o.shell.openExternal(e),{action:"deny"})),t.once("ready-to-show",()=>{t&&(t.show(),f&&t.webContents.openDevTools({mode:"detach"}))}),t.on("closed",()=>{t=null}),t.on("close",e=>{o.app.quitting||!1?(t=null,process.platform!=="darwin"&&o.app.quit()):(e.preventDefault(),t&&t.hide())})};async function R(){try{console.log("Initializing application..."),o.session.defaultSession.webRequest.onHeadersReceived((e,r)=>{const s=["default-src 'self'","script-src 'self' 'unsafe-inline' 'unsafe-eval'","style-src 'self' 'unsafe-inline'","img-src 'self' data:","connect-src 'self' https:"].join("; ");r({responseHeaders:{...e.responseHeaders,"Content-Security-Policy":s}})}),console.log("Registering IPC handlers..."),q(),console.log("Creating main window..."),await g(),console.log("Application initialization complete")}catch(e){console.error("Failed to initialize app:",e),o.app.quit()}}o.app.on("window-all-closed",()=>{process.platform!=="darwin"&&o.app.quit()});o.app.on("activate",()=>{o.BrowserWindow.getAllWindows().length===0&&g().catch(e=>{console.error("Failed to create window:",e),o.app.quit()})});process.on("uncaughtException",e=>{console.error("Uncaught Exception:",e),o.app.quit()});process.on("unhandledRejection",(e,r)=>{console.error("Unhandled Rejection at:",r,"reason:",e)});o.app.whenReady().then(()=>{R().catch(e=>{console.error("Failed to initialize app:",e),o.app.quit()})}).catch(e=>{console.error("Failed to start application:",e),o.app.quit()});
